import { useEffect, useMemo, useState } from "react"
import { Message } from "~/lib/firebase/firestore"
import leafs from "../leafs"
import styles from "./tree.module.scss"

type TreeProps = {
  messages: Message[]
}

const splitMessage = (messages: Message[]) => {
  return messages.reduce<{ left: Message[]; right: Message[] }>(
    (res, msg, i) => {
      const dir = i % 2 === 0 ? "left" : "right"
      res[dir].push(msg)
      return res
    },
    { left: [], right: [] }
  )
}

const Tree = ({ messages }: TreeProps) => {
  const [start, setStart] = useState(false)
  const { left, right } = useMemo(() => {
    return splitMessage(messages)
  }, [messages])

  useEffect(() => {
    setTimeout(() => {
      setStart(true)
    }, messages.length * 300)
  }, [])

  return (
    <div className={`${styles.container} ${start ? styles.start : ""}`}>
      <TopOfTree />
      <div className={`${styles.col} ${styles.colLeft}`}>
        {leafs({
          messages: left,
          dir: "left",
        })}
      </div>
      <div className={`${styles.col} ${styles.colRight}`}>
        {leafs({
          messages: right,
          dir: "right",
        })}
      </div>
      <div className={styles.rootOfTree}></div>
    </div>
  )
}

const TopOfTree = () => (
  <div className={styles.topOfTree}>
    <svg
      width="79"
      height="105"
      viewBox="0 0 79 105"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M24.1 7.62177C32.5 14.5415 36.4 22.063 32.7 26.5759C29 31.0888 21.1 29.4842 12.7 22.5645C5.2 16.2464 4.2 8.42406 0 0.60171C5.1 -1.10316 15.7 0.701996 24.1 7.62177Z"
        fill="#63C79D"
      />
      <path
        d="M53.0998 18.1519C47.0998 23.1662 44.2998 28.4814 46.8998 31.6905C49.4998 34.8997 55.1998 33.7966 61.1998 28.7822C66.5998 24.3696 67.2998 18.7536 70.2998 13.0372C66.6998 11.8338 59.0998 13.1375 53.0998 18.1519Z"
        fill="#63C79D"
      />
      <path
        d="M49.6998 28.7822C48.0998 30.1862 46.6998 31.6905 45.2998 33.1948C43.9998 34.6991 42.6998 36.2034 41.4998 37.7077C41.3998 37.106 41.2998 36.5043 41.1998 36.0029C40.4998 33.2951 39.1998 30.6877 37.3998 28.6819C35.5998 26.6762 33.3998 25.1719 31.1998 23.8682C28.9998 22.6648 26.5998 21.6619 24.2998 20.659C26.3998 22.063 28.4998 23.467 30.3998 24.9713C32.2998 26.4756 33.9998 28.2808 35.2998 30.2865C36.4998 32.2923 37.1998 34.3983 37.3998 36.6046C37.3998 37.2063 37.3998 37.7077 37.3998 38.3095L37.1998 40.1146C37.0998 41.3181 36.9998 42.4212 36.6998 43.5244C36.5998 44.1261 36.3998 44.6275 36.1998 45.1289L35.9998 45.4298H36.0998C35.9998 45.7307 35.7998 46.0315 35.6998 46.3324C35.4998 46.8338 35.0998 47.3352 34.7998 48.0373C34.4998 48.7393 34.1998 49.6418 33.9998 50.4441C33.7998 51.2464 33.6998 52.149 33.6998 52.851C33.5998 53.553 33.5998 54.3553 33.5998 55.0573C33.5998 56.5616 33.6998 57.9656 33.8998 59.3696C34.2998 62.1776 34.7998 64.5845 34.5998 65.9885C34.5998 66.0888 34.5998 66.1891 34.4998 66.3897L34.3998 66.8911L34.1998 67.7937C34.0998 68.3954 33.9998 68.9971 33.8998 69.5989C33.6998 70.8023 33.5998 72.0057 33.4998 73.3095V105H45.4998V73.3095C45.3998 72.0057 45.1998 70.8023 44.9998 69.4986L44.2998 65.5874C44.0998 63.7822 43.5998 62.2779 43.0998 60.9742L41.7998 57.5645C41.3998 56.4613 41.0998 55.4585 40.8998 54.4556C40.7998 53.9542 40.6998 53.4527 40.5998 52.851C40.4998 52.3496 40.4998 51.9484 40.4998 51.447C40.4998 51.0458 40.4998 50.6447 40.6998 50.2436C40.7998 49.7421 40.9998 49.2407 41.1998 48.4384C41.1998 48.3381 41.2998 48.2378 41.2998 48.1375H41.3998L42.3998 45.5301C43.0998 43.7249 43.8998 41.8195 44.7998 40.0143C45.6998 38.2092 46.5998 36.404 47.4998 34.5989C48.4998 32.894 49.4998 31.0888 50.6998 29.4842C51.8998 27.8797 53.0998 26.2751 54.5998 24.8711C52.8998 26.0745 51.2998 27.3782 49.6998 28.7822Z"
        fill="#7D7560"
      />
      <path
        d="M45.4999 73.3095C45.3999 72.0057 45.1999 70.8023 44.9999 69.4986L44.2999 65.5874C44.0999 63.7822 43.5999 62.2779 43.0999 60.9742L41.7999 57.5645C41.3999 56.4613 41.0999 55.4585 40.8999 54.4556C40.7999 53.9542 40.6999 53.4527 40.5999 52.851C40.4999 52.3496 40.4999 51.9484 40.4999 51.6476L40.2999 51.0459L39.3999 105H45.3999L45.4999 73.3095Z"
        fill="#544C3C"
      />
    </svg>
  </div>
)

export default Tree
